<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ההזמנות שלי - Tiv</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/user.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
</head>
<body>
    <div class="navbar">
        <a href="index.html">
            <h2>Tiv</h2>
        </a>
        <a href="cart.html">
            <div class="cart">
                <i class="bi bi-cart2"></i>
                <div id="cartAmount" class="cartAmount">0</div>
            </div>
        </a>
    </div>

    <div class="orders-container">
        <h2>ההזמנות שלי</h2>
        
        <!-- הזמנה אחרונה -->
        <div class="last-order">
            <h3>הזמנה אחרונה</h3>
            <div id="lastOrderDetails"></div>
        </div>

        <!-- היסטוריית הזמנות -->
        <div class="order-history">
            <h3>היסטוריית הזמנות</h3>
            <div id="orderHistory"></div>
        </div>
    </div>

    <script type="module">
        // טעינת פרטי ההזמנה האחרונה
        const lastOrder = JSON.parse(localStorage.getItem("lastOrder"));
        const lastOrderDetails = document.getElementById("lastOrderDetails");
        const orderHistory = document.getElementById("orderHistory");

        // עדכון כמות המוצרים בעגלה
        const updateCartIcon = () => {
            const basket = JSON.parse(localStorage.getItem("data")) || [];
            const cartIcon = document.getElementById("cartAmount");
            cartIcon.textContent = basket.reduce((sum, item) => sum + item.item, 0);
        };

        // הצגת פרטי ההזמנה האחרונה
        const displayLastOrder = () => {
            if (lastOrder) {
                lastOrderDetails.innerHTML = `
                    <div class="order-card">
                        <div class="order-header">
                            <span>מספר הזמנה: ${lastOrder.id}</span>
                            <span>תאריך: ${new Date(lastOrder.orderDate).toLocaleDateString()}</span>
                            <span>סטטוס: ${lastOrder.status}</span>
                        </div>
                        <div class="order-items">
                            ${lastOrder.items.map(item => `
                                <div class="order-item">
                                    <span>${item.name}</span>
                                    <span>כמות: ${item.quantity}</span>
                                    <span>מחיר: ₪${item.price}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="order-total">
                            <strong>סה"כ לתשלום: ₪${lastOrder.totalAmount}</strong>
                        </div>
                    </div>
                `;
            } else {
                lastOrderDetails.innerHTML = '<p>אין הזמנה אחרונה</p>';
            }
        };

        // טעינת היסטוריית הזמנות מהשרת
        const loadOrderHistory = async () => {
            try {
                const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
                if (!loggedInUser) {
                    window.location.href = "login.html";
                    return;
                }

                const response = await fetch(`http://localhost:3000/api/orders/${loggedInUser.id}`);
                if (!response.ok) throw new Error('שגיאה בטעינת היסטוריית ההזמנות');
                
                const orders = await response.json();
                displayOrderHistory(orders);
            } catch (error) {
                console.error("שגיאה בטעינת היסטוריית ההזמנות:", error);
                orderHistory.innerHTML = '<p>שגיאה בטעינת היסטוריית ההזמנות</p>';
            }
        };

        // הצגת היסטוריית ההזמנות
        const displayOrderHistory = (orders) => {
            if (orders && orders.length > 0) {
                orderHistory.innerHTML = orders.map(order => `
                    <div class="order-card">
                        <div class="order-header">
                            <span>מספר הזמנה: ${order.id}</span>
                            <span>תאריך: ${new Date(order.orderDate).toLocaleDateString()}</span>
                            <span>סטטוס: ${order.status}</span>
                        </div>
                        <div class="order-items">
                            ${order.items.map(item => `
                                <div class="order-item">
                                    <span>${item.name}</span>
                                    <span>כמות: ${item.quantity}</span>
                                    <span>מחיר: ₪${item.price}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="order-total">
                            <strong>סה"כ לתשלום: ₪${order.totalAmount}</strong>
                        </div>
                    </div>
                `).join('');
            } else {
                orderHistory.innerHTML = '<p>אין הזמנות קודמות</p>';
            }
        };

        // אתחול הדף
        updateCartIcon();
        displayLastOrder();
        loadOrderHistory();
    </script>
</body>
</html> 